name: Upload & Restart on Oracle Cloud

on:
  workflow_run:
    # workflows: ["Release Go Binary"]
    # types: [completed]

jobs:
  deploy:
    # if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    name: Deploy to Oracle Cloud Always Free

    steps:
    - name: Checkout code (to get version)
      uses: actions/checkout@v4

    - name: Download built artifact from previous job
      uses: actions/download-artifact@v4
      with:
        name: todo-linux-amd64
        path: ./dist

    - name: Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ${{ secrets.ORACLE_USER }}
        key: ${{ secrets.ORACLE_SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e

          # Create directory if not exists
          mkdir -p /opt/todo-app

          # Stop existing service (if running)
          sudo systemctl stop todo || true

          # Backup previous binary
          [ -f /opt/todo-app/todo ] && mv /opt/todo-app/todo /opt/todo-app/todo.old || true

          # Upload new binary
          # (the file will be placed in current directory after scp)
          sudo mv todo-linux-amd64 /opt/todo-app/todo
          sudo chmod +x /opt/todo-app/todo

          # Optional: restart service
          sudo systemctl daemon-reload
          sudo systemctl restart todo

          echo "Deployment completed - $(date)"
          sudo systemctl status todo --no-pager -l || true